<template>
<div class="row no-gutters mx-auto">
  <div class="col-12 mb-5 text-center">
    <h1>
      Velkommen til Stand-up Sara!
    </h1>
  </div>
  <b-card class="col-12 col-md-5 bg-light text-left">
    <h5>Hvem er med i dag?</h5>
    <b-btn
      v-for="(p, i) in participants"
      size="sm"
      variant="primary"
      class="mr-2"
      :key="`participant-${i}`"
      @click="addUser(p, i)"
    >
      {{ p }}
    </b-btn>
    <b-btn
      size="sm"
      variant="success"
      class="mr-2"
      @click="addAllUsers()"
    >
      Alle!
      <font-awesome-icon
        icon="smile-beam"
        class="ml-1"
        spin
      >
      </font-awesome-icon>
    </b-btn>
    <div class="mt-3">
      <b-btn variant="dark" size="sm" @click="displayCustom = !displayCustom">
        Egendefinert
      </b-btn>
      <b-input-group v-if="displayCustom" size="sm" class="text-right mt-2">
        <b-input v-model="customName" placeholder="Navn..." :state="customName.length > 1">
        </b-input>
        <b-input-group-append>
          <b-btn variant="success" @click="addCustomUser()">
            Legg til
          </b-btn>
        </b-input-group-append>
      </b-input-group>
      <b-alert :show="error" size="sm" variant="danger">
        {{ error }}
      </b-alert>
    </div>
  </b-card>
  <b-card class="col-12 col-md-5 offset-md-2 text-left">
    <h5 v-if="selectedParticipants.length">Valgt</h5>
    <font-awesome-icon
      v-if="loading"
      icon="circle-notch"
      spin
    >
    </font-awesome-icon>
    <div v-else>
      <b-btn
        v-for="(sp, si) in selectedParticipants"
        class="mx-1"
        size="sm"
        variant="dark"
        :key="`selected-participant-${si}`"
        @click="removeUser(sp, si)"
      >
        {{ sp }}
        <font-awesome-icon icon="times"></font-awesome-icon>
      </b-btn>
      <b-btn
        v-if="selectedParticipants.length"
        size="sm"
        variant="danger"
        @click="removeAllUsers()"
      >
        Fjern alle
      </b-btn>
    </div>
  </b-card>
  <div class="col-12 text-center">
    <b-btn v-if="selectedParticipants.length > 1" class="mt-2" variant="success" size="lg" :disabled="loading === true" @click="selectRandom()">
      Hvem starter, Sara? <font-awesome-icon icon="magic"></font-awesome-icon>
    </b-btn>
  </div>
  <div
    v-if="operator"
    :class="operator.class"
    class="operator position-fixed bottom-right"
  >
    <div class="col-12 sara-dialogue text-center position-absolute">
      <div class="chat-bubble mt-2">
        <h3 class="mt-2">
          <span :style="sentenceStyle">{{ sentence }}</span>
          <span class="spin"></span>
          <span v-if="loading">
            <span class="spin">游뱕</span>
          </span>
        </h3>
      </div>
      <div class="app-version">
        Versjon <strong>{{ appVersion }}</strong>
      </div>
    </div>
  </div>
</div>
</template>
<script>
// @ is an alias to /src
import Participants from '@/assets/users.json'
import Sentences from '@/assets/sentences.json'
import Operators from '@/assets/operators.json'
export default {
  name: 'home',
  data () {
    return {
      appVersion: require('../../package.json').version,
      participants: Participants,
      selectedParticipants: [],
      displayCustom: false,
      customName: '',
      error: null,
      timeoutId: null,
      sentence: 'Hei, alle sammen og velkommen til stand up!',
      introSentences: Sentences.intro,
      loadingSentences: Sentences.loading,
      operators: Operators,
      loading: false,
      voiceRate: 0.9,
      pitch: 1.0,
      operator: null,
      voice: 'Norwegian Female',
      turnTypes: [
        'direction',
        'random',
        'chosen',
        'backwards'
      ]
    }
  },
  mounted () {
    const selected = this.fisherYates(this.introSentences)[0]
    let selectedIntro = selected.text || selected
    this.operator = this.randomItem(this.operators)
    if (this.operator.name !== 'Sara') {
      this.sentence = `Hei. Sara er dessverre ikke her i dag, s친 dere m친 ta til takke med meg, ${this.operator.name}. `
      this.sentence += `Sara bad meg om 친 si: ${selectedIntro}`
    } else {
      this.sentence = selectedIntro
    }
    this.sentenceStyle = selected.style || {}
    window.setTimeout(() => {
      window.responsiveVoice.speak(this.sentence, this.operator.voice, { rate: this.voiceRate, pitch: this.operator.pitch })
    }, 2000)
  },
  computed: {
    participantsSorted () {
      // Avoid some unexpected side-effects.
      let temp = this.participants
      temp = temp.sort((a, b) => a.toLowerCase() > b.toLowerCase())
      return temp
    },
    selectedOperator () {
      if (this.operator) {
        return this.operator
      } else {
        return ''
      }
    }
  },
  methods: {
    fisherYates (input) {
      let a = input
      var aLength = a.length
      for (var i = aLength - 1; i >= 0; i--) {
        var randomIndex = Math.floor(Math.random() * (i + 1))
        var itemAtIndex = a[randomIndex]
        a[randomIndex] = a[i]
        a[i] = itemAtIndex
      }
      return a
    },
    randomItem (input) {
      if (input) {
        const seed = Math.random()
        let ix = 0
        // Set Sara probability to 50%
        if (Number.parseFloat(seed) < 0.5) {
          console.log('Sara is here!')
          ix = 0
        } else {
          console.log('Sara is away, using other operator')
          ix = Math.floor(Math.random() * input.length)
        }
        return input[ix]
      }
    },
    addCustomUser () {
      this.error = null
      if (!this.participants.some(e => e.trim().toLowerCase() === this.customName.trim().toLowerCase())) {
        this.participants.push(this.customName)
      } else {
        this.error = 'Navnet finnes allerede.'
      }
    },
    addUser (user, index) {
      this.participants.splice(index, 1)
      this.selectedParticipants.push(user)
    },
    addAllUsers () {
      this.selectedParticipants = this.participants
      this.participants = []
      this.everyoneAdded = true
    },
    random (max = 10) {
      // TODO: Invalid when max is 1
      return ~~(Math.random() * max) + 1
    },
    removeUser (user, index) {
      this.selectedParticipants.splice(index, 1)
      this.participants.push(user)
    },
    removeAllUsers () {
      this.selectedParticipants = []
      this.participants = Participants
    },
    selectRandom () {
      this.loading = true
      // Determine direction and order of users
      const turnType = this.fisherYates(this.turnTypes)[0]
      const shuffled = this.fisherYates(this.selectedParticipants)
      let sentence = ''
      switch (turnType) {
        case 'direction':
          const direction = (this.random(2) % 2) ? 'med klokken' : 'mot klokken'
          sentence = `I dag tror jeg vi starter med ${shuffled[0]} og g친r ${direction}.`
          break
        case 'chosen':
          sentence = `Allright! I dag bestemmer jeg rekkef칮lgen! Hva med ${shuffled.join(' s친 ')}?`
          break
        case 'random':
          sentence = `Bananas! Denne gangen starter vi med ${shuffled[0]} ogs친 velger ${shuffled[1]} hvem som er neste, hver gang! Spinnvilt, sp칮r du meg.`
          break
        case 'backwards':
          let reversed = shuffled
          reversed = reversed.reverse()
          sentence = `Denne gangen g친r vi bakover! Det vil si ${reversed.join(' s친 ')}. Litt rart, men slik ble det i dag.`
          break
      }

      const onLoadingSentenceCompleted = () => {
        setTimeout(() => {
          this.sentence = sentence
          this.sentenceStyle = {}
          window.responsiveVoice.speak(this.sentence, this.operator.voice, { rate: this.voiceRate, pitch: this.operator.pitch })
          this.loading = false
        }, 1500)
      }

      let selectedLoadingSentence = this.fisherYates(this.loadingSentences)[0]
      this.sentence = selectedLoadingSentence.text || selectedLoadingSentence
      this.sentenceStyle = selectedLoadingSentence.style || {}
      window.responsiveVoice.speak(this.sentence, this.operator.voice, { rate: this.voiceRate, pitch: this.operator.pitch, onend: onLoadingSentenceCompleted })
    }
  }
}
</script>
<style scoped>
.spin {
  animation: 1.2s rotation infinite linear;
  position: absolute;
}

@keyframes rotation {
  from {
    transform: rotate(0deg);
  }

  to {
    transform: rotate(359deg);
  }
}

</style>
